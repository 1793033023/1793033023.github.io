<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>Exercises 2&colon; Importing Data from CSV Files Using TiDB Lightning</title>
        <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
        
    </head>
    <body class="vscode-body vscode-light">
        <h1 id="exercises-2-importing-data-from-csv-files-using-tidb-lightning">Exercises 2: Importing Data from CSV Files Using TiDB Lightning</h1>
<h3 id="overview">Overview</h3>
<ul>
<li>In these exercises, you import data from CSV files into TiDB Playground cluster using <code>TiDB Lightning</code>.</li>
</ul>
<h3 id="notes">Notes</h3>
<ul>
<li>Some of the steps require that you type commands in two different terminal windows. You might find it convenient to launch two terminals and keep them open for the duration of the exercises.</li>
<li>Your environment may be different with these exercises, including but not limited to <code>IP</code>, <code>port</code>, <code>username</code>, <code>password</code> and <code>directory</code>.</li>
<li>The <code>$</code> in the terminal window is OS prompt.</li>
<li>The &quot;<code>tidb&gt;</code>&quot; or &quot;<code>mysql&gt;</code>&quot; in the terminal window is SQL command prompt.</li>
<li>These exercises can be run on a single machine, such as laptop.</li>
</ul>
<h3 id="assumptions">Assumptions</h3>
<ul>
<li>You are using macOS or Linux.</li>
<li>You have cloned the <a href="https://github.com/pingcap/tidb-course-201-lab.git">lab repository</a>.</li>
<li>You have completed the Exercises 1.</li>
</ul>
<h2 id="exercise-2-1-importing-data-from-csv-files-into-tidb-in-physical-mode">Exercise 2-1: Importing Data from CSV Files into TiDB in Physical Mode</h2>
  <img src="file:////Users/zhanghao/tidb-course-201/lab-guide/guide/en/201.3/diagram/2013E021_aa_001_20230406.png" width="60%" align="top"/>
<h3 id="overview-1">Overview</h3>
<ul>
<li>The physical import mode is a highly efficient method for importing data into the storage layer, without using the SQL interface. This mode is especially valuable for importing large data sets of hundreds of terabytes or more.</li>
</ul>
<h3 id="duration">Duration</h3>
<ul>
<li>This exercise should take you approximately 10 minutes to complete.</li>
</ul>
<h3 id="tasks">Tasks</h3>
<ol>
<li>Verify the data to be imported.</li>
<li>Verify the <code>TiDB Lightning</code> import task configuration.</li>
<li>Import data into TiDB using <code>TiDB Lightning</code> physical mode.</li>
</ol>
<h3 id="solutions">Solutions</h3>
<ol>
<li>
<p>Create a user <code>imp</code> for the data importing task:</p>
<pre><code>$ cd tidb-course-201-lab/scripts/
$ ./connect-4000.sh
</code></pre>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> imp@<span class="hljs-string">&#x27;%&#x27;</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;q1w2e3R4_&#x27;</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> PRIVILEGES <span class="hljs-keyword">ON</span> <span class="hljs-operator">*</span>.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> imp@<span class="hljs-string">&#x27;%&#x27;</span>;
</code></pre>
<pre><code>tidb:4000&gt; CREATE USER imp@'%' IDENTIFIED BY 'q1w2e3R4_';
Query OK, 0 rows affected (0.05 sec)

tidb:4000&gt; GRANT ALL PRIVILEGES ON *.* TO imp@'%';
Query OK, 0 rows affected (0.05 sec)
</code></pre>
<pre><code>tidb:4000&gt; exit;
</code></pre>
</li>
<li>
<p>List the contents of the source data directory <code>misc/planets-csv-large-1</code>. Enter the following command at the terminal prompt and receive the results shown.</p>
<pre><code>$ ls ./misc/planets-csv-large-1/
total 89632
-rw-r--r--  1 username  staff       100 Apr  6 08:05 universe-schema-create.sql
-rw-r--r--  1 username  staff      1777 Nov  6 14:14 universe.planets-schema.sql
-rw-r--r--  1 username  staff  45109100 Apr  6 18:06 universe.planets.000000000.csv
-rwxr-xr-x  1 username  staff       573 Apr  6 18:06 universe.stars-schema.sql
-rw-rw-r--  1 username  staff       301 Apr  6 18:05 universe.stars.csv
</code></pre>
</li>
<li>
<p>The SQL script named <code>universe-schema-create.sql</code> is utilized for creating the <code>universe</code> schema.</p>
<pre><code>$ cat ./misc/planets-csv-large-1/universe-schema-create.sql
</code></pre>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> DATABASE `universe`
<span class="hljs-comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 */</span>
;
</code></pre>
</li>
<li>
<p>The SQL script named <code>universe.planets-schema.sql</code> is utilized for creating the <code>planets</code> table.</p>
<pre><code>$ cat ./misc/planets-csv-large-1/universe.planets-schema.sql 
</code></pre>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `planets` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
  `name` <span class="hljs-type">char</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;&#x27;</span>,
  `mass` <span class="hljs-type">float</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0.0&#x27;</span> COMMENT <span class="hljs-string">&#x27;10**24 kg&#x27;</span>,
  `diameter` <span class="hljs-type">decimal</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;km&#x27;</span>,
  `density` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;kg/m**3&#x27;</span>,
  `gravity` <span class="hljs-type">decimal</span>(<span class="hljs-number">8</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0.0&#x27;</span> COMMENT <span class="hljs-string">&#x27;m/s**2&#x27;</span>,
  `escape_velocity` <span class="hljs-type">decimal</span>(<span class="hljs-number">8</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0.0&#x27;</span> COMMENT <span class="hljs-string">&#x27;km/s&#x27;</span>,
  `rotation_period` <span class="hljs-type">decimal</span>(<span class="hljs-number">5</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0.0&#x27;</span> COMMENT <span class="hljs-string">&#x27;hours&#x27;</span>,
  `length_of_day` <span class="hljs-type">decimal</span>(<span class="hljs-number">8</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0.0&#x27;</span> COMMENT <span class="hljs-string">&#x27;hours&#x27;</span>,
  `distance_from_sun` <span class="hljs-type">float</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0.0&#x27;</span> COMMENT <span class="hljs-string">&#x27;10**6 km&#x27;</span>,
  `perihelion` <span class="hljs-type">float</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;10**6 km&#x27;</span>,
  `aphelion` <span class="hljs-type">float</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;10**6 km&#x27;</span>,
  `orbital_period` <span class="hljs-type">decimal</span>(<span class="hljs-number">12</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0.0&#x27;</span> COMMENT <span class="hljs-string">&#x27;days&#x27;</span>,
  `orbital_velocity` <span class="hljs-type">decimal</span>(<span class="hljs-number">12</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;km/s&#x27;</span>,
  `orbital_inclination` <span class="hljs-type">decimal</span>(<span class="hljs-number">8</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;degrees&#x27;</span>,
  `orbital_eccentricity` <span class="hljs-type">decimal</span>(<span class="hljs-number">7</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0.0&#x27;</span>,
  `obliquity_to_orbit` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">4</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;degrees&#x27;</span>,
  `mean_temperature` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;C&#x27;</span>,
  `surface_pressure` <span class="hljs-type">float</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;bars&#x27;</span>,
  `ring_systems` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span>,
  `global_magnetic_field` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span>,
  `sun_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `category_id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `discover_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-comment">/*T![clustered_index] CLUSTERED */</span>,
  KEY `name` (`name`),
  <span class="hljs-keyword">CONSTRAINT</span> `planet_sun_fk` <span class="hljs-keyword">FOREIGN</span> KEY (`sun_id`) <span class="hljs-keyword">REFERENCES</span> `stars` (`id`),
  <span class="hljs-keyword">CONSTRAINT</span> `planet_cat_fk` <span class="hljs-keyword">FOREIGN</span> KEY (`category_id`) <span class="hljs-keyword">REFERENCES</span> `planet_categories` (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_bin AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">40510553</span>;
</code></pre>
</li>
<li>
<p>The SQL script named <code>universe.stars-schema.sql</code> is utilized for creating the <code>stars</code> table.</p>
<pre><code>$ cat ./misc/planets-csv-large-1/universe.starts-schema.sql
</code></pre>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `stars` (
  `id` <span class="hljs-type">bigint</span> AUTO_RANDOM,
  `name` <span class="hljs-type">char</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;&#x27;</span>,
  `mass` <span class="hljs-type">float</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0.0</span> COMMENT <span class="hljs-string">&#x27;10**24 kg&#x27;</span>,
  `density` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">&#x27;kg/m**3&#x27;</span>,
  `gravity` <span class="hljs-type">decimal</span>(<span class="hljs-number">20</span>, <span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0.0</span> COMMENT <span class="hljs-string">&#x27;m/s**2&#x27;</span>,
  `escape_velocity` <span class="hljs-type">decimal</span>(<span class="hljs-number">8</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;km/s&#x27;</span>,
  `mass_conversion_rate` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;10**6 kg/s&#x27;</span>,
  `spectral_type` <span class="hljs-type">char</span>(<span class="hljs-number">8</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;&#x27;</span>,
  `distance_from_earth` <span class="hljs-type">float</span> COMMENT <span class="hljs-string">&#x27;light year&#x27;</span>,
  `discover_date` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  KEY (`name`)
);
</code></pre>
</li>
<li>
<p>Verify that the files <code>universe.planets.000000000.csv</code> and <code>universe.stars.csv</code> contain 327680 planets and 2 stars respectively. These files are for demonstration purposes only and do not contain actual data.</p>
<pre><code>$ head -5 ./misc/planets-csv-large-1/universe.planets.000000000.csv 
&quot;id&quot;,&quot;name&quot;,&quot;mass&quot;,&quot;diameter&quot;,&quot;density&quot;,&quot;gravity&quot;,&quot;escape_velocity&quot;,&quot;rotation_period&quot;,&quot;length_of_day&quot;,&quot;distance_from_sun&quot;,&quot;perihelion&quot;,&quot;aphelion&quot;,&quot;orbital_period&quot;,&quot;orbital_velocity&quot;,&quot;orbital_inclination&quot;,&quot;orbital_eccentricity&quot;,&quot;obliquity_to_orbit&quot;,&quot;mean_temperature&quot;,&quot;surface_pressure&quot;,&quot;ring_systems&quot;,&quot;global_magnetic_field&quot;,&quot;sun_id&quot;,&quot;category_id&quot;,&quot;discover_date&quot;
1,&quot;Mercury&quot;,0.33,4879.00,5429,3.7,4.3,1407.6,4222.6,57.9,46,69.8,88.0,47.4,7.0,0,0.0340,167,0,0,1,7782220156096217089,1,\N
2,&quot;Venus&quot;,4.87,12104.00,5234,8.9,10.4,-5832.5,2802.0,108.2,107.5,108.9,224.7,35.0,3.4,0,177.4000,464,92,0,0,7782220156096217089,1,\N
3,&quot;Earth&quot;,5.97,12756.00,5514,9.8,11.2,23.9,24.0,149.6,147.1,152.1,365.2,29.8,0.0,0,23.4000,15,1,0,1,7782220156096217089,1,\N
4,&quot;Mars&quot;,0.642,6792.00,3934,3.7,5.0,24.6,24.7,228,206.7,249.3,687.0,24.1,1.8,0,25.2000,-65,0.01,0,0,7782220156096217089,1,\N
</code></pre>
<pre><code>$ wc -l ./misc/planets-csv-large-1/universe.planets.000000000.csv
      327680 ./misc/planets-csv-large-1/universe.planets.000000000.csv
</code></pre>
<pre><code>$ head -5 ./misc/planets-csv-large-1/universe.stars.csv 
&quot;id&quot;,&quot;name&quot;,&quot;mass&quot;,&quot;density&quot;,&quot;gravity&quot;,&quot;escape_velocity&quot;,&quot;mass_conversion_rate&quot;,&quot;spectral_type&quot;,&quot;distance_from_earth&quot;,&quot;discover_date&quot;
1,&quot;Sun&quot;,1988500,1408,274.0000,617.6,4260,&quot;G2 V&quot;,0.0000158,\N
3170534137668829186,&quot;Proxima Centauri&quot;,244600,56800,0.0520,\N,\N,&quot;M5.5 Ve&quot;,4.426,&quot;1915-01-01 00:00:00&quot;
</code></pre>
<pre><code>$ wc -l ./misc/planets-csv-large-1/universe.stars.csv
      3 ./misc/planets-csv-large-1/universe.stars.csv
</code></pre>
</li>
<li>
<p>Review the content of the provided <code>TiDB Lightning</code> task configuration file and take note that the value of the <code>backend</code> attribute in section <code>[tikv-importer]</code> is set to <code>local</code>. This configuration indicates that <code>TiDB Lightning</code> is operating in physical mode, importing data directly into the storage layer without passing through the SQL layer. Ensure that the <code>data-source-dir</code> attribute located under the <code>[mydumper]</code> section is correctly pointing to the <code>./misc/planets-csv-large-1</code> directory and the credentials under section <code>[tidb]</code> are the same as the ones created for the user in step 1.</p>
<pre><code>$ cat ./misc/lightning-universe-planets-csv-physical.toml 
[lightning]
level = &quot;info&quot;
file = &quot;../stage/tidb-lightning-universe.log&quot;
table-concurrency = 1
index-concurrency = 1
region-concurrency = 1
io-concurrency = 1
max-error = 0
task-info-schema-name = &quot;lightning_task_info&quot;
meta-schema-name = &quot;lightning_metadata&quot;

[checkpoint]
enable = true
driver = &quot;file&quot;
dsn = &quot;/tmp/tidb_lightning_checkpoint_physical.pb&quot;

[tikv-importer]
backend = &quot;local&quot;
incremental-import = false
sorted-kv-dir = &quot;../stage/sorted-kv-dir-1&quot;

[mydumper]
data-source-dir = &quot;./misc/planets-csv-large-1&quot;
filter = ['*.*', '!mysql.*', '!sys.*', '!INFORMATION_SCHEMA.*', '!PERFORMANCE_SCHEMA.*', '!METRICS_SCHEMA.*', '!INSPECTION_SCHEMA.*']
strict-format = true

[mydumper.csv]
separator = ','
delimiter = '&quot;'
terminator = ''
header = true
not-null = false
null = '\N'
backslash-escape = true
trim-last-separator = false

[tidb]
host = &quot;127.0.0.1&quot;
port = 4000
user = &quot;imp&quot;
password = &quot;q1w2e3R4_&quot;
status-port = 10080
pd-addr = &quot;127.0.0.1:2379&quot;
</code></pre>
</li>
<li>
<p>Initiate the import task. Enter the following command at the terminal prompt and receive the results shown. Since the environment is TiDB Playground cluster, ignore the warning in check item 7.</p>
<pre><code>$ tiup tidb-lightning --config ./misc/lightning-universe-planets-csv-physical.toml 
tiup is checking updates for component tidb-lightning ...
Starting component `tidb-lightning`: /Users/username/.tiup/components/tidb-lightning/v6.5.1/tidb-lightning /Users/username/.tiup/components/tidb-lightning/v6.5.1/tidb-lightning --config ./misc/lightning-universe-planets-csv-physical.toml
Verbose debug logs will be written to ../stage/tidb-lightning-universe.log

+----+------------------------------------------------------------------------------------------------------------------------------------+-------------+--------+
|  # | CHECK ITEM                                                                                                                         | TYPE        | PASSED |
+----+------------------------------------------------------------------------------------------------------------------------------------+-------------+--------+
|  1 | Skip the csv size check, because config.StrictFormat is true                                                                       | performance | true   |
+----+------------------------------------------------------------------------------------------------------------------------------------+-------------+--------+
|  2 | the checkpoints are valid                                                                                                          | critical    | true   |
+----+------------------------------------------------------------------------------------------------------------------------------------+-------------+--------+
|  3 | table schemas are valid                                                                                                            | critical    | true   |
+----+------------------------------------------------------------------------------------------------------------------------------------+-------------+--------+
|  4 | all importing tables on the target are empty                                                                                       | critical    | true   |
+----+------------------------------------------------------------------------------------------------------------------------------------+-------------+--------+
|  5 | Cluster version check passed                                                                                                       | critical    | true   |
+----+------------------------------------------------------------------------------------------------------------------------------------+-------------+--------+
|  6 | Lightning has the correct storage permission                                                                                       | critical    | true   |
+----+------------------------------------------------------------------------------------------------------------------------------------+-------------+--------+
|  7 | sorted-kv-dir:../stage/sorted-kv-dir-1 and data-source-dir:/Users/username/git/github/tidb-course-201-lab/scripts/misc/planets-csv | performance | false  |
|    | -large-1 are in the same disk, may slow down performance                                                                           |             |        |
+----+------------------------------------------------------------------------------------------------------------------------------------+-------------+--------+
|  8 | local disk resources are rich, estimate sorted data size 14.34MiB, local available is 103.5GiB                                     | critical    | true   |
+----+------------------------------------------------------------------------------------------------------------------------------------+-------------+--------+
|  9 | The storage space is rich, which TiKV/Tiflash is 310.5GiB/103.5GiB. The estimated storage space is 14.34MiB/0B.                    | performance | true   |
+----+------------------------------------------------------------------------------------------------------------------------------------+-------------+--------+
| 10 | Cluster doesn't have too many empty regions                                                                                        | performance | true   |
+----+------------------------------------------------------------------------------------------------------------------------------------+-------------+--------+
| 11 | Cluster region distribution is balanced                                                                                            | critical    | true   |
+----+------------------------------------------------------------------------------------------------------------------------------------+-------------+--------+
| 12 | no CDC or PiTR task found                                                                                                          | critical    | true   |
+----+------------------------------------------------------------------------------------------------------------------------------------+-------------+--------+

tidb lightning exit successfully
</code></pre>
</li>
<li>
<p>(Optional) If any problems related to inaccurate configuration were encountered during the previous step, this error message may be encountered when re-executing the import task - <code>Checkpoint for ... has invalid status</code>. Note that <a href="https://pingcap.com/education/">PingCAP Training and Certification</a> provides a private training course <em>TiDB Administration</em> that contains detailed instructions and hands-on labs on how to use tools related to TiDB cluster administration, such as TiDB Lightning, Dumping, TiDB Data Migration, etc.</p>
<pre><code>$ rm /tmp/tidb_lightning_checkpoint_physical.pb
</code></pre>
</li>
<li>
<p>Verify that the data has been imported.</p>
<pre><code>$ ./connect-4000.sh
</code></pre>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> universe.planets;
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> universe.stars;
</code></pre>
<pre><code>tidb:4000&gt; SELECT COUNT(*) FROM universe.planets;
+----------+
| COUNT(*) |
+----------+
|   327680 |
+----------+
1 row in set (0.20 sec)

tidb:4000&gt; SELECT COUNT(*) FROM universe.stars;
+----------+
| COUNT(*) |
+----------+
|        2 |
+----------+
1 row in set (0.00 sec)
</code></pre>
</li>
</ol>
<h2 id="exercise-2-2-importing-data-from-csv-files-into-tidb-in-logical-mode">Exercise 2-2: Importing Data from CSV Files into TiDB in Logical Mode</h2>
  <img src="file:////Users/zhanghao/tidb-course-201/lab-guide/guide/en/201.3/diagram/2013E022_aa_001_20230406.png" width="60%" align="top"/>
<h3 id="overview-2">Overview</h3>
<ul>
<li>During the logical import mode, TiDB Lightning encodes the data into SQL statements and subsequently executes them to import data.</li>
</ul>
<h3 id="duration-1">Duration</h3>
<ul>
<li>This exercise should take you approximately 5 minutes to complete.</li>
</ul>
<h3 id="tasks-1">Tasks.</h3>
<ol>
<li>Verify the <code>TiDB Lightning</code> import task configuration.</li>
<li>Import data into TiDB using <code>TiDB Lightning</code> physical mode.</li>
</ol>
<h3 id="solutions-1">Solutions</h3>
<ol>
<li>
<p>Truncate both tables imported in Exercise 2-1:</p>
<pre><code>$ cd tidb-course-201-lab/scripts/
$ ./connect-4000.sh
</code></pre>
<pre><code class="language-sql"><span class="hljs-keyword">TRUNCATE</span> universe.planets;
<span class="hljs-keyword">TRUNCATE</span> universe.stars;
</code></pre>
<pre><code>tidb:4000&gt; TRUNCATE universe.stars;
Query OK, 0 rows affected (0.65 sec)

tidb:4000&gt; TRUNCATE universe.planets;
Query OK, 0 rows affected (0.53 sec)
</code></pre>
<pre><code>tidb:4000&gt; exit;
</code></pre>
</li>
<li>
<p>Review the content of the provided <code>TiDB Lightning</code> task configuration file and take note that the value of the <code>backend</code> attribute in section <code>[tikv-importer]</code> is set to <code>tidb</code>. This configuration indicates that <code>TiDB Lightning</code> is operating in logical mode.</p>
<pre><code>$ cat ./misc/lightning-universe-planets-csv-logical.toml 
[lightning]
level = &quot;info&quot;
file = &quot;../stage/tidb-lightning-universe.log&quot;
table-concurrency = 1
index-concurrency = 1
region-concurrency = 1
io-concurrency = 1
max-error = 0
task-info-schema-name = &quot;lightning_task_info&quot;
meta-schema-name = &quot;lightning_metadata&quot;

[checkpoint]
enable = true
driver = &quot;file&quot;
dsn = &quot;/tmp/tidb_lightning_checkpoint_physical.pb&quot;

[tikv-importer]
backend = &quot;tidb&quot;
incremental-import = false
sorted-kv-dir = &quot;../stage/sorted-kv-dir-1&quot;

[mydumper]
data-source-dir = &quot;./misc/planets-csv-large-1&quot;
filter = ['*.*', '!mysql.*', '!sys.*', '!INFORMATION_SCHEMA.*', '!PERFORMANCE_SCHEMA.*', '!METRICS_SCHEMA.*', '!INSPECTION_SCHEMA.*']
strict-format = true

[mydumper.csv]
separator = ','
delimiter = '&quot;'
terminator = ''
header = true
not-null = false
null = '\N'
backslash-escape = true
trim-last-separator = false

[tidb]
host = &quot;127.0.0.1&quot;
port = 4000
user = &quot;imp&quot;
password = &quot;q1w2e3R4_&quot;
status-port = 10080
pd-addr = &quot;127.0.0.1:2379&quot;
</code></pre>
</li>
<li>
<p>Initiate the import task. Enter the following command at the terminal prompt and receive the results shown.</p>
<pre><code>$ tiup tidb-lightning --config ./misc/lightning-universe-planets-csv-logical.toml
tiup is checking updates for component tidb-lightning ...timeout!
Starting component `tidb-lightning`: /Users/username/.tiup/components/tidb-lightning/v7.0.0/tidb-lightning /Users/username/.tiup/components/tidb-lightning/v7.0.0/tidb-lightning --config ./misc/lightning-universe-planets-csv-logical.toml
Verbose debug logs will be written to ../stage/tidb-lightning-universe.log

+---+--------------------------------------------------------------+-------------+--------+
| # | CHECK ITEM                                                   | TYPE        | PASSED |
+---+--------------------------------------------------------------+-------------+--------+
| 1 | Skip the csv size check, because config.StrictFormat is true | performance | true   |
+---+--------------------------------------------------------------+-------------+--------+
| 2 | the checkpoints are valid                                    | critical    | true   |
+---+--------------------------------------------------------------+-------------+--------+
| 3 | Cluster version check passed                                 | critical    | true   |
+---+--------------------------------------------------------------+-------------+--------+
| 4 | Lightning has the correct storage permission                 | critical    | true   |
+---+--------------------------------------------------------------+-------------+--------+

tidb lightning exit successfully
</code></pre>
</li>
<li>
<p>Verify that the data has been imported.</p>
<pre><code>$ ./connect-4000.sh
</code></pre>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> universe.planets;
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> universe.stars;
</code></pre>
<pre><code>tidb:4000&gt; SELECT COUNT(*) FROM universe.planets;
+----------+
| COUNT(*) |
+----------+
|   327680 |
+----------+
1 row in set (0.20 sec)

tidb:4000&gt; SELECT COUNT(*) FROM universe.stars;
+----------+
| COUNT(*) |
+----------+
|        2 |
+----------+
1 row in set (0.00 sec)
</code></pre>
</li>
<li>
<p>In the real world, it is not uncommon for TiDB Lightning to efficiently handle the import of tens of terabytes of data into TiDB, especially when it comes to migration. If you are interested in conducting a production-level test or demo, <a href="https://www.pingcap.com/demo/?utm_source=edu&amp;utm_medium=referral&amp;utm_campaign=201.3.E2">click here</a> to apply.</p>
</li>
</ol>
<h2 id="end-of-exercises-2">End of Exercises 2</h2>

        <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
        
    </body>
    </html>